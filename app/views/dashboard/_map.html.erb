<!-- app/views/dashboard/_map.html.erb -->
<div class="relative w-full h-full">
  <!-- Background Map SVG -->
  <div class="absolute inset-0">
    <%= image_tag 'map_of_middle_earth.svg',
                  class: 'w-full h-full object-contain',
                  alt: 'Map of Middle Earth' %>
  </div>

  <!-- Overlay for Path and Tokens -->
  <svg class="absolute inset-0 w-full h-full pointer-events-none"
       viewBox="0 0 100 100"
       preserveAspectRatio="xMidYMid meet">

    <!-- The Journey Path -->
    <path id="journey-path"
          d="<%= path_coordinates(path) %>"
          stroke="#8B4513"
          stroke-width="0.5"
          fill="none"
          stroke-dasharray="1,1"
          opacity="0.7" />

    <!-- Milestone Markers -->
    <% path&.milestones&.each do |milestone| %>
      <g class="milestone-marker" data-milestone-id="<%= milestone.id %>">
        <!-- Marker Circle -->
        <circle cx="<%= milestone.map_position_x %>"
                cy="<%= milestone.map_position_y %>"
                r="1.5"
                fill="#8B0000"
                stroke="#FFD700"
                stroke-width="0.3" />

        <!-- Milestone Name -->
        <text x="<%= milestone.map_position_x %>"
              y="<%= milestone.map_position_y - 2 %>"
              font-size="2"
              fill="#2C1810"
              font-weight="bold"
              text-anchor="middle"
              class="pointer-events-auto">
          <%= milestone.name %>
        </text>
      </g>
    <% end %>

    <!-- User Tokens -->
    <% users.each_with_index do |user, index| %>
      <% path_user = user.current_position_on_path(path) %>
      <% position = calculate_token_position(path_user, path) %>

      <g class="user-token"
         data-user-id="<%= user.id %>"
         data-turbo-permanent
         style="transform: translate(<%= position[:x] %>px, <%= position[:y] %>px);">

        <!-- Token Circle with User Color -->
        <circle cx="<%= position[:x] %>"
                cy="<%= position[:y] + (index * 1.5) %>"
                r="1"
                fill="<%= user.token_color %>"
                stroke="white"
                stroke-width="0.2"
                class="transition-all duration-1000 ease-in-out" />

        <!-- User Initial -->
        <text x="<%= position[:x] %>"
              y="<%= position[:y] + (index * 1.5) + 0.5 %>"
              font-size="1.2"
              fill="white"
              font-weight="bold"
              text-anchor="middle">
          <%= user.name[0] %>
        </text>
      </g>
    <% end %>
  </svg>
</div>
